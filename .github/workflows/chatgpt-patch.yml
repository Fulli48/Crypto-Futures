name: ChatGPT Patch Processor

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-patch:
    if: contains(github.event.issue.body, '[CHATGPT PATCH]') || contains(github.event.comment.body, '[CHATGPT PATCH]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity (global)
        shell: bash
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Extract patch from issue/comment body (inside OR outside fence)
        id: extract
        shell: bash
        run: |
          set -euo pipefail
          BODY_FILE="$RUNNER_TEMP/body.txt"
          PATCH_FILE="$RUNNER_TEMP/chatgpt.patch"

          jq -r '.issue.body // .comment.body // empty' "$GITHUB_EVENT_PATH" > "$BODY_FILE"

          echo "---- BEGIN RAW BODY (first 40 lines) ----"
          head -n 40 "$BODY_FILE" || true
          echo "---- END RAW BODY ----"

          # Accept [CHATGPT PATCH] either on its own line BEFORE the fence,
          # or INSIDE the fenced block (we'll ignore the marker line).
          awk '
            BEGIN { inblk=0; has=0; n=0; after=0 }
            # fence line
            /^```/ {
              if (!inblk) { inblk=1; has=0; n=0; next }
              else {
                if (inblk && has) { for (i=1;i<=n;i++) print buf[i]; exit }
                inblk=0; next
              }
            }
            {
              if (inblk) {
                if ($0 ~ /\[CHATGPT PATCH\]/) { has=1; next }   # ignore marker line inside fence
                buf[++n]=$0
              } else {
                if ($0 ~ /\[CHATGPT PATCH\]/) { after=1 }       # header BEFORE fence
                else if (after && /^```/) { inblk=1; has=1; n=0; after=0; next }
              }
            }
            END {
              if (inblk && has) { for (i=1;i<=n;i++) print buf[i] }
            }
          ' "$BODY_FILE" > "$PATCH_FILE"

          echo "---- BEGIN EXTRACTED PATCH (first 60 lines) ----"
          head -n 60 "$PATCH_FILE" || true
          echo "---- END EXTRACTED PATCH ----"

          if [ ! -s "$PATCH_FILE" ]; then
            echo "ERROR: No valid patch content found near [CHATGPT PATCH]." >&2
            exit 1
          fi

          echo "patch_file=$PATCH_FILE" >> "$GITHUB_OUTPUT"

      - name: Create/refresh dev branch (clean)
        shell: bash
        run: |
          set -e
          rm -f body.txt chatgpt.patch || true
          git rebase --abort || true
          git cherry-pick --abort || true
          git am --abort || true
          git fetch origin --prune
          if git ls-remote --exit-code --heads origin dev >/dev/null 2>&1; then
            git checkout -B dev origin/dev
          else
            git checkout -B dev origin/main || git checkout -B dev main
          fi
          git fetch origin main
          git reset --hard origin/main

      - name: Apply patch and commit (3-way, tolerant)
        shell: bash
        run: |
          set -e
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git rebase --abort || true
          git cherry-pick --abort || true
          git am --abort || true

          PATCH="${{ steps.extract.outputs.patch_file }}"

          if git apply --3way --ignore-space-change --whitespace=fix "$PATCH"; then
            echo "Applied with git apply."
          else
            echo "git apply failed — trying git am..." >&2
            if git am --3way --keep-non-patch "$PATCH"; then
              echo "Applied with git am."
            else
              echo "ERROR: Could not apply patch." >&2
              git am --abort || true
              exit 1
            fi
          fi

          if ! git diff --quiet || ! git diff --cached --quiet; then
            git add -A
            git commit -m "Apply ChatGPT patch from issue #${{ github.event.issue.number }}"
          else
            echo "No changes after applying patch."
          fi

      - name: Push dev branch
        shell: bash
        run: |
          set -e
          git push --force-with-lease origin dev

      - name: Ensure PR dev -> main exists (robust; skip when no diffs)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          OWNER_REPO="${GITHUB_REPOSITORY}"
          TITLE="ChatGPT Patch from Issue #${{ github.event.issue.number }}"
          BODY="Automated PR created from a [CHATGPT PATCH] in issue #${{ github.event.issue.number }}."

          echo "== PR STEP START =="
          git fetch origin main dev || git fetch origin
          AHEAD="$(git rev-list --left-right --count origin/main...origin/dev | awk '{print $2}')" || AHEAD=0
          echo "dev ahead of main by ${AHEAD:-0} commits"
          if [ "${AHEAD:-0}" = "0" ]; then
            echo "Nothing to PR (dev == main). Skipping PR creation."
            exit 0
          fi

          PR_NUMBER="$(gh pr list --head dev --base main --state all --json number -q '.[0].number' || true)"
          echo "Existing PR number: ${PR_NUMBER:-<none>}"
          if [[ -n "$PR_NUMBER" && "$PR_NUMBER" != "null" ]]; then
            STATE="$(gh pr view "$PR_NUMBER" --json state -q .state 2>/dev/null || echo unknown)"
            echo "Existing PR state: $STATE"
            if [ "$STATE" != "open" ]; then
              echo "Reopening PR #$PR_NUMBER via issues API…"
              gh api -X PATCH "/repos/${OWNER_REPO}/issues/${PR_NUMBER}" -f state=open >/dev/null
            fi
            echo "Updating PR #$PR_NUMBER title/body…"
            gh api -X PATCH "/repos/${OWNER_REPO}/pulls/${PR_NUMBER}" -f title="$TITLE" -f body="$BODY" >/dev/null
            echo "PR #$PR_NUMBER updated."
            exit 0
          fi

          echo "Creating new PR dev -> main…"
          set +e
          gh api -X POST "/repos/${OWNER_REPO}/pulls" \
            -f title="$TITLE" -f head="dev" -f base="main" -f body="$BODY" >/dev/null
          STATUS=$?
          set -e
          if [ $STATUS -ne 0 ]; then
            echo "Create returned $STATUS; checking if PR exists now…"
            PR_NUMBER="$(gh pr list --head dev --base main --state all --json number -q '.[0].number' || true)"
            if [[ -n "$PR_NUMBER" && "$PR_NUMBER" != "null" ]]; then
              echo "PR already exists as #$PR_NUMBER. Success."
              exit 0
            fi
            echo "PR creation failed and no PR found. Failing."
            exit 1
          fi
          echo "PR created successfully."
          echo "== PR STEP END =="
